---
title: "Exclusion"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Exclusion Criteria

```{r}
library(tidyverse)
library(glue)
```

```{r}
pprint = function(title, mask) {
  print(glue(title, ":"))
  print(glue(sum(mask), " total"))
  print(glue(round(mean(mask), 2)*100, "%"))
}
```

## Load Data

Load the data straight from `clean_data.R`. Execution of the steps below *must* occur before the main analysis and exploratory analysis.

```{r}
trials = read_csv("data/data_clean.csv", col_types = cols()) %>%
  mutate(
    english = factor(english, levels = c("Y", "N", "NA"))
  )

nStart = nrow(trials)
glue(nStart, " participants to begin with")
```

## Criteria

### Native English check

Exclude ppts who didn't indicate that English was their native language.

```{r}
pprint("Non-Native English", trials$english != "Y")

trials = trials %>% filter(english == "Y")
glue(nStart - nrow(trials), " participants removed")
```

### Bot check

Exclude ppts who failed to correctly answer the bot check questions

```{r}
CHECK1_ANS = 1
CHECK2_ANS = 2
pprint("Failed the first bot check question", trials$check1 != CHECK1_ANS)

trials = trials %>% filter(check1 == CHECK1_ANS)
glue(nStart - nrow(trials), " participants removed")

pprint("Failed the second bot check question", trials$check2 != CHECK2_ANS)

trials = trials %>% filter(check2 == CHECK2_ANS)
glue(nStart - nrow(trials), " participants removed")
```

### Comprehension check

Exclude ppts who fail to demonstrate comprehension of the stimulus

```{r}
minimumTrialRT = 5000 # in Milliseconds

pprint("Minimum Trial RT", trials$rt_trial < minimumTrialRT)

# trials = trials %>% filter(rt_trial >= minimumTrialRT)
glue(nStart - nrow(trials), " participants removed")

trials$description = trimws(trials$description)
# trials[is.na(trials$description), ]$description = ""

pprint("Empty Description Responses", trials$description == "")

trials = trials %>% filter(description != "")
glue(nStart - nrow(trials), " participants removed")
```

```{r}
trialRTBinBreaks = seq(0, 1, length.out = 5)
trials$rt_trial_group = cut(trials$rt_trial / 1000, breaks = quantile(trials$rt_trial / 1000, trialRTBinBreaks), include.lowest = T)

round(trialRTBinBreaks, 2)
table(trials$rt_trial_group)
```

### Manipulation Identification check

Flag all responses to the purpose identification question that include at least one of a handful of critical keywords.

```{r}
keywords = c("metaphor", "metaphors", "framing", "manipulate", "manipulates", "manipulated", "manipulating", "worded", "wording", "phrased", "phrasing", "measure", "measuring", "measured")

purpose_flag = function(text) {
  # lowercase
  t = tolower(text)
  # remove all punctuation and extra spacing from the text
  t = gsub('[[:punct:] ]+', ' ', t)
  # return a string of the keywords mentioned in the reponse
  return(paste(intersect(keywords, strsplit(t, " ")[[1]]), collapse = ","))
}

trials$purpose_flag = sapply(trials$purpose, purpose_flag)
```

```{r}
trials[trials$purpose_flag != "", c("ppt", "purpose", "purpose_flag")]
```

```{r}
exclude_ppts = c() # fill in with any ppts who should be excluded based upon inspection above
trials = trials[!(trials$ppt %in% exclude_ppts), ]
```

```{r}
glue(nStart - nrow(trials), " participants removed in total")
```

## Save Data

```{r}
write_csv(trials, "data/data_clean.csv")
```




