---
title: "Exploration"
output:
  html_document:
    toc: true
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(boot)
theme = theme_minimal()
```

# Experimental Analysis

## Load and Clean Data

Created via `clean_data.R`.

```{r}
sc = function(x) {
  return((x - mean(x, na.rm = T)) / (2 * sd(x, na.rm = T)))
}


data = read_csv("data/clean_data.csv", col_types = cols()) %>%
              mutate(
              cond_sex = factor(cond_sex, levels = c("male", "female")),
              cond_metaphor = factor(cond_metaphor, levels = c("literal", "battle", "journey")),

              rt_trial = rt_trial / (1000 * 60), # convert to floating point minutes
              total_time = total_time / (1000 * 60), # convert to floating point minutes
              
              age.z = sc(age),
              exp_cancer = (self_cancer == "Y" | ff_cancer == "Y"),
              
              urgent = as.integer(urgent),
              sympathy = as.integer(sympathy),
              peace = as.integer(peace),
              guilty = as.integer(guilty),
              
              gender = factor(gender, levels = c("M", "F", "NB")),
              self_cancer = factor(self_cancer, levels = c("Y", "N")),
              ff_cancer = factor(ff_cancer, levels = c("Y", "N")),
              english = factor(english, levels = c("Y", "N")),
              socioeconomic = factor(socioeconomic, levels = c("<10k", "10-25k", "25-50k", "50-75k", "75-100k", "100-150k", ">150k")),
              education = factor(education, levels = c("<HS", "HS", "A", "B", "M", "P", "D")))
```

## Exploration

Participants per cell

```{r}
t = table(data[, c("cond_metaphor", "cond_sex")])
t = cbind(t, rowSums(t))
colnames(t)[3] = "Total"
t = rbind(t, colSums(t))
rownames(t)[4] = "Total"
t
```

```{r}
head(data)
```

### Experiment Duration

```{r}
summary(data$rt_trial)
summary(data$total_time)
ggplot(data) + theme +
  geom_density(aes(total_time)) +
  labs(x = "Total Duration (mins)", y = "Density", title = "Total Duration Distribution")
```


First, 5th, 50th, and 95th quantiles for the actual trial response time. Then the mean trial response time. Then 5th, 50th, and 95th quantiles for experiment total duration. Lastly, mean total experiment duration.

```{r}
quantile(data$rt_trial, c(0.05, 0.5, 0.95))
mean(data$rt_trial)
quantile(data$total_time, c(0.05, 0.5, 0.95))
mean(data$total_time)
```

Take a look at the fastest and slowest participants to see if they are completely unreasonable outliers

```{r}
data %>%
  arrange(rt_trial) %>%
  head()
```

```{r}
data %>%
  arrange(desc(rt_trial)) %>%
  head()
```

### Prominent Donation Behaviors

First, summary stats of the donations. Then, proportion of participants who donate $0, $25, and $50. These are natural breaks (minimum, default/middle, maximum) that might signal certain behavior (e.g. people often giving nothing, staying with the default value).

```{r}
summary(data$donation)
mean(data$donation == 0)
mean(data$donation == 25)
mean(data$donation == 50)
```

If the participant is rushing through the experiment and donates the default amount, we might expect to see that a donation of $25 predicts the trial response time (beyond what is predicted by the conditions).

```{r}
time.model = lm(rt_trial ~ cond_sex*cond_metaphor, data = data)
time.model.full = lm(rt_trial ~ I(donation == 25) + cond_sex*cond_metaphor, data = data)
anova(time.model, time.model.full, test = "Chisq")
```

### Donations

How do participants in each of the conditions behave?

First, simple histograms of donation amounts, both overall and broken up by condition.

```{r}
ggplot(data) + theme +
  geom_histogram(aes(donation), binwidth = 2.5) +
  labs(x = "Donation Amount", y = "Count", title = "Donation Distribution") +
  lims(x=c(0, 50))

ggplot(data) + theme +
  geom_histogram(aes(donation), binwidth = 2.5, position = "identity") +
  labs(x = "Donation Amount", y = "Count", title = "Donation Distributions by Condition") +
  facet_grid(vars(cond_sex), vars(cond_metaphor)) +
  lims(x=c(0, 50))
```

## Predictors

```{r}
summary(data$sympathy, digits = 2)
summary(data$urgent, digits = 2)
```

Quick peek at the differences in donation amounts given how much participants agreed with the followup questions.

```{r}
data %>%
  gather(question, value, urgent:guilty) %>%
  ggplot(aes(as.factor(value), donation)) +
  geom_boxplot() +
  facet_grid(rows = vars(question))
```

Distribution of the followup questions

```{r}
ggplot(data) + theme +
  geom_bar(aes(urgent, group=1, y=..prop..)) +
  scale_x_discrete(limits = seq(0,6)) +
  labs(x = "Urgent", y = "Proportion", title = "Urgent Distribution", subtitle = "\"Her situation is urgent.\"")

ggplot(data) + theme +
  geom_bar(aes(sympathy, group=1, y=..prop..)) +
  scale_x_discrete(limits = seq(0,6)) +
  labs(x = "Sympathy", y = "Proportion", title = "Sympathy Distribution", subtitle = "\"Her situation is one I sympathize with.\"")
```

```{r}
lbs = c("male" = "Condition: Male",
        "female" = "Condition: Female")

ggplot(data) + theme +
  geom_bar(aes(urgent, fill = cond_metaphor), width = 0.9, position = position_dodge(preserve = "single")) +
  lims(x = c(0, 6)) +
  labs(x = "Urgent", y = "Count", title = "Urgent Distribution", subtitle = "\"Her situation is urgent.\"") +
  facet_grid(~cond_sex, labeller = as_labeller(lbs)) # remove this line to graph only the metaphor condition

ggplot(data) + theme +
  geom_bar(aes(sympathy, fill = cond_metaphor), width = 0.9, position = position_dodge(preserve = "single")) +
  lims(x = c(0, 6)) +
  labs(x = "Sympathy", y = "Count", title = "Sympathy Distribution", subtitle = "\"Her situation is sympathy\"") +
  facet_grid(~cond_sex, labeller = as_labeller(lbs))  # remove this line to graph only the metaphor condition
```

Correlation analysis between intrinsic factors and donation, and between both instrinsic factors

```{r}
cor.test(data$urgent, data$donation, method = "spearman", alternative = "two.sided")
cor.test(data$sympathy, data$donation, method = "spearman", alternative = "two.sided")
```

```{r}
cor.test(data$sympathy, data$urgent, method = "spearman", alternative = "two.sided")
```

### Sympathy

Does the metaphorical condition have a relationship to participant's rating of perceived sympathy?

```{r}
sympathy.model = lm(sympathy ~ gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = data)
sympathy.model.full = lm(sympathy ~ cond_metaphor + gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = data)

summary(sympathy.model.full)
anova(sympathy.model, sympathy.model.full, test = "Chisq")
```

### Urgency

Does the metaphorical condition have a relationship to participant's rating of perceived urgency?

```{r}
urgent.model = lm(urgent ~ gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = data)
urgent.model.full = lm(urgent ~ cond_metaphor*cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = data)

summary(urgent.model.full)
anova(urgent.model, urgent.model.full, test = "Chisq")
```

## Peace and Guilt

```{r}
lbs = c("male" = "Condition: Male",
        "female" = "Condition: Female")

ggplot(data) + theme +
  geom_bar(aes(peace, fill = cond_metaphor), width = 0.9, position = position_dodge(preserve = "single")) +
  lims(x = c(0, 6)) +
  labs(x = "Peace", y = "Count", title = "Peace Distribution", subtitle = "\"She can make peace with her experience.\"") +
  facet_grid(~cond_sex, labeller = as_labeller(lbs)) # remove this line to graph only the metaphor condition

ggplot(data) + theme +
  geom_bar(aes(guilty, fill = cond_metaphor), width = 0.9, position = position_dodge(preserve = "single")) +
  lims(x = c(0, 6)) +
  labs(x = "Guilty", y = "Count", title = "Guilty Distribution", subtitle = "\"She will feel guilty that she hasnâ€™t done enough if she does not recover.\"") +
  facet_grid(~cond_sex, labeller = as_labeller(lbs)) # remove this line to graph only the metaphor condition
```

Correlation analysis between peace/guilty and donation, and between both peace and guilty

```{r}
cor.test(data$peace, data$donation, method = "spearman", alternative = "two.sided")
cor.test(data$guilty, data$donation, method = "spearman", alternative = "two.sided")
cor.test(data$peace, data$guilty, method = "spearman", alternative = "two.sided")
```

```{r}
data$pg_diff = data$peace - data$guilty
```

```{r}
summary(aov(pg_diff ~ cond_metaphor, data = data))
```


## Demographics

Explore the distributions of demographic variables.

```{r}
ggplot(data) +
  geom_density(aes(donation, color=self_cancer)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Self Cancer", title = "Donation Distributions by Education Level")

ggplot(data) +
  geom_density(aes(donation, color=ff_cancer)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Friends and Family\nCancer", title = "Donation Distributions by Friends and Family Cancer")

ggplot(data) +
  geom_density(aes(donation, color=gender)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Gender", title = "Donation Distributions by Gender")

ggplot(data) +
  geom_density(aes(donation, color=education)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Education Level", title = "Donation Distributions by Education Level")

ggplot(data) +
  geom_density(aes(donation, color=socioeconomic)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Socioeconomic Level", title = "Donation Distributions by Socioeconomic Level")

ggplot(data) +
  geom_density(aes(donation, color=english)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Native English", title = "Donation Distributions by Native English")

ggplot(data, aes(exp_cancer, donation)) +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(width = 0.1) +
  lims(y = c(0, 50)) +
  labs(title = "Donation distributions by Overall Cancer Experience")
```

### Gender-matching effect

Is there a relationship between participant gender, stimulus sex, and donation?

```{r}
gender.match.model = lm(donation ~ cond_sex + education + socioeconomic + age.z + self_cancer + ff_cancer, data = data[!is.na(data$gender), ])
gender.match.model.full = lm(donation ~ gender*cond_sex + education + socioeconomic + age.z + self_cancer + ff_cancer, data = data[!is.na(data$gender), ])

summary(gender.match.model.full)
anova(gender.match.model, gender.match.model.full, test = "Chisq")
```

### Experience-matching effect

Is there a relationship between participant's experience with cancer and donation?

```{r}
exp.cancer.model = lm(donation ~ gender + education + socioeconomic + age.z, data = data[!is.na(data$exp_cancer), ])
exp.cancer.model.full = lm(donation ~ exp_cancer + gender + education + socioeconomic + age.z, data = data[!is.na(data$exp_cancer), ])

summary(exp.cancer.model.full)
anova(exp.cancer.model, exp.cancer.model.full, test = "Chisq")
```



# Sean's explorations

## Predicting guilt/peace scores

```{r}

data$ppt_gender = fct_recode(data$gender,
                             "male" = "M",
                             "female" = "F")
data$ppt_gender = factor(data$ppt_gender, levels=c("male", "female"))

data$congruent_gender = data$ppt_gender == data$cond_sex


data$diff = data$peace - data$guilty
df_just_metaphor = data %>%
  filter(cond_metaphor != "literal")
```


### Possible 3-way interaction?

Probably spurious, but there's a strange 3-way interaction going on between `ppt gender`, `metaphor`, and `patient gender`. 

```{r}


df_just_metaphor %>%
  ggplot(aes(x = cond_metaphor,
             y = diff,
             color = gender)) +
  stat_summary (fun.y = function(x){mean(x)},
                fun.ymin = function(x){mean(x) - 1*sd(x)/sqrt(length(x))},
                fun.ymax = function(x){mean(x) + 1*sd(x)/sqrt(length(x))},
                geom= 'pointrange', 
                position=position_dodge(width=0.95)) +
  labs(x = "Metaphor condition",
       y = "Peace - guilt score",
       title = "Peace/guilt score by metaphor and gender") +
  theme_minimal() +
  facet_grid(~cond_sex)

summary(lm(data = df_just_metaphor,
           diff ~ cond_metaphor * cond_sex * gender))


```


Effect of gender **congruence**?

```{r}
df_just_metaphor %>%
  ggplot(aes(x = cond_metaphor,
             y = diff,
             color = congruent_gender)) +
  stat_summary (fun.y = function(x){mean(x)},
                fun.ymin = function(x){mean(x) - 1*sd(x)/sqrt(length(x))},
                fun.ymax = function(x){mean(x) + 1*sd(x)/sqrt(length(x))},
                geom= 'pointrange', 
                position=position_dodge(width=0.95)) +
  labs(x = "Metaphor condition",
       y = "Peace - guilt score",
       title = "Peace/guilt score by metaphor and gender congruence") +
  theme_minimal()

summary(lm(data = df_just_metaphor,
           diff ~ cond_metaphor * congruent_gender))
```

# Sample Random ppt

```{r}
pilot = read_csv("pilot_data/clean_pilot.csv")
```

```{r}
length(unique(pilot$ppt))
length(unique(data$ppt))
ids = c(pilot$ppt, data$ppt)
length(ids)
```

```{r}
id = sample(ids, 1)
if (id %in% pilot$ppt) {
  print(pilot[pilot$ppt == id, c("ppt", "donation")])
} else {
  print(data[data$ppt == id, c("ppt", "donation")])
}
```

