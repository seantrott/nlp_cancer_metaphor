---
title: "Power"
output:
  html_document:
    toc: true
    toc_float: true
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(simr)
theme = theme_minimal()
```

# Mediation Analysis

## Load clean data

Created via `clean_data.R`.

```{r}
sc = function(x) {
  return((x - mean(x, na.rm = T)) / (2 * sd(x, na.rm = T)))
}

df_cleaned = read_csv("data/clean_data.csv", col_types = cols()) %>%
              mutate(
              cond_sex = factor(cond_sex, levels = c("male", "female")),
              cond_metaphor = factor(cond_metaphor, levels = c("literal", "battle", "journey")),
              cond_anymet = cond_metaphor %in% c("battle", "journey"),
              
              rt_trial = rt_trial / (1000 * 60), # convert to floating point minutes
              total_time = total_time / (1000 * 60), # convert to floating point minutes
              
              age.z = sc(age),
              exp_cancer = (self_cancer == "Y" | ff_cancer == "Y"),
              
              urgent = as.integer(urgent),
              sympathy = as.integer(sympathy),
              peace = as.integer(peace),
              guilty = as.integer(guilty),
              
              gender = factor(gender, levels = c("M", "F", "NB")),
              self_cancer = factor(self_cancer, levels = c("Y", "N")),
              ff_cancer = factor(ff_cancer, levels = c("Y", "N")),
              english = factor(english, levels = c("Y", "N")),
              socioeconomic = ordered(socioeconomic, levels = c("<10k", "10-25k", "25-50k", "50-75k", "75-100k", "100-150k", ">150k")),
              education = ordered(education, levels = c("<HS", "HS", "A", "B", "M", "P", "D")))
```

```{r}
df_complete = df_cleaned %>%
  dplyr::select(donation, cond_anymet, cond_metaphor, cond_sex, gender, education, socioeconomic, age.z, self_cancer, ff_cancer) %>%
  drop_na()
```

## Any metaphor condition

```{r}
table(df_complete$cond_anymet)
```

First, we create a full model of any_metpahor on donation amount. This reflects our foremost hypothesis about the effect of metaphor on donation behavior.

```{r}
model = glm(donation ~ cond_anymet + cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = df_complete, family = "gaussian")
```

Then we build a power simulation model, comparing the full model to a reduced model.

```{r}
ps = powerSim(model, nsim = 500, seed = 42,
              test = compare(donation ~ cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer))

ps
```

To get an idea of how many participants in each factor of cond_anymet we would need for sufficient power, we extend the dataframe through sampling and rebuild the model. Then we plot a power curve as a function of participants in the positive cond_anymet class.

```{r}
df2 = extend(df_complete, within="cond_anymet", n=1000)

model = glm(donation ~ cond_anymet + cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = df2, family = "gaussian")

p = powerCurve(model, seed = 42,
               test = compare(donation ~ cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer),
               within = "cond_anymet",
               breaks = c(50, 250, 500, 750, 1000))
```

```{r}
table(df2$cond_anymet)
```

```{r}
plot(p)
```

## Metaphorical condition

```{r}
model = glm(donation ~ cond_metaphor + cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = df_complete, family = "gaussian")

table(df_complete$cond_metaphor)
```

```{r}
ps = powerSim(model, nsim = 500, seed = 42,
              test = compare(donation ~ cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer))

ps
```

To get an idea of how many participants in each factor of cond_metaphor we would need for sufficient power, we extend the dataframe through sampling and rebuild the model. Then we plot a power curve as a function of participants in the positive cond_anymet class.

```{r}
df2 = extend(df_complete, within="cond_metaphor", n=800)

model = glm(donation ~ cond_metaphor + cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer, data = df2, family = "gaussian")

p = powerCurve(model, seed = 42,
               test = compare(donation ~ cond_sex + gender + education + socioeconomic + age.z + self_cancer + ff_cancer),
               within = "cond_metaphor",
               breaks = c(50, 200, 400, 600, 800))
```

```{r}
table(df2$cond_metaphor)
```

```{r}
plot(p)
```

## Rose and Lera's Replication

First we subset the data to include only the non-null variables we are interested in. Then we create base models on this data and perform power analysis for each.

```{r}
df_repl = df_cleaned
df_repl$diff = df_cleaned$peace - df_cleaned$guilty
df_repl = df_repl %>%
  filter(cond_metaphor != "literal") %>%
  dplyr::select(diff, cond_anymet, cond_metaphor, cond_sex, gender, education, socioeconomic, age.z, self_cancer, ff_cancer) %>%
  drop_na()
```

```{r}
model.reduced = glm(diff ~ cond_sex + gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                    data = df_repl,
                    family = "gaussian")

model.just_met = glm(diff ~ cond_metaphor + cond_sex + gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                     data = df_repl,
                     family = "gaussian")

model.ppt_gender_metaphor_interaction = glm(diff ~ cond_metaphor*gender + cond_sex + education + socioeconomic + self_cancer + ff_cancer + age.z,
                                            data = df_repl,
                                            family = "gaussian")

model.patient_gender_metaphor_interaction = glm(diff ~ cond_metaphor*cond_sex + gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                                                data = df_repl,
                                                family = "gaussian")

model.both_interactions = glm(diff ~ cond_metaphor*cond_sex + cond_metaphor*gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                              data = df_repl,
                              family = "gaussian")
```

```{r}
powerSim(model.just_met, nsim = 500, seed = 42,
         test = compare(model.reduced))

powerSim(model.ppt_gender_metaphor_interaction, nsim = 500, seed = 42,
         test = compare(model.just_met))

powerSim(model.patient_gender_metaphor_interaction, nsim = 500, seed = 42,
         test = compare(model.just_met))

powerSim(model.both_interactions, nsim = 500, seed = 42,
         test = compare(model.just_met)) # what's the proper reduced model here?
```

Now we extend the data with more simulated samples and rebuild the models. Follwoing that, we plot out power curves for each comparison's power given number of participants.

```{r}
df_repl2 = extend(df_repl, within="cond_metaphor", n=800)

model.reduced = glm(diff ~ cond_sex + gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                    data = df_repl2,
                    family = "gaussian")

model.just_met = glm(diff ~ cond_metaphor + cond_sex + gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                     data = df_repl2,
                     family = "gaussian")

model.ppt_gender_metaphor_interaction = glm(diff ~ cond_metaphor*gender + cond_sex + education + socioeconomic + self_cancer + ff_cancer + age.z,
                                            data = df_repl2,
                                            family = "gaussian")

model.patient_gender_metaphor_interaction = glm(diff ~ cond_metaphor*cond_sex + gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                                                data = df_repl2,
                                                family = "gaussian")

model.both_interactions = glm(diff ~ cond_metaphor*cond_sex + cond_metaphor*gender + education + socioeconomic + self_cancer + ff_cancer + age.z, 
                              data = df_repl2,
                              family = "gaussian")
```

```{r}
plot(powerCurve(model.just_met, seed = 42,
               test = compare(model.reduced),
               within = "cond_metaphor",
               breaks = c(50, 200, 400, 600, 800)))

plot(powerCurve(model.ppt_gender_metaphor_interaction, seed = 42,
               test = compare(model.just_met),
               within = "cond_metaphor",
               breaks = c(50, 200, 400, 600, 800)))

plot(powerCurve(model.patient_gender_metaphor_interaction, seed = 42,
               test = compare(model.just_met),
               within = "cond_metaphor",
               breaks = c(50, 200, 400, 600, 800)))

plot(powerCurve(model.both_interactions, seed = 42,
               test = compare(model.just_met),
               within = "cond_metaphor",
               breaks = c(50, 200, 400, 600, 800))) # Again, what's the most appropriate reduced model?
```

