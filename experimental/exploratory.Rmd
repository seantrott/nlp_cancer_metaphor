---
title: "Exploration"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(jtools)
tm = theme_minimal()
```

# Experiment Exploratory Analysis

## Load Data

Created via `clean_data.R`.

```{r}
trials = read_csv("data_pilot_N200/data_clean.csv", col_types = cols()) %>%
  select(ppt:age) %>%
  mutate(
    cond_sex = factor(cond_sex, levels = c("male", "female")),
    cond_metaphor = factor(cond_metaphor, levels = c("literal", "battle", "journey")),
    cond_anymet = cond_metaphor %in% c("battle", "journey"),
    
    self_cancer = factor(self_cancer, levels = c("N", "Y", "NA")),
    ff_cancer = factor(ff_cancer, levels = c("N", "Y", "NA")),
    
    urgent = as.integer(urgent),
    sympathy = as.integer(sympathy),
    
    gender = factor(gender, levels = c("M", "F", "NB"), labels = c("Male", "Female", "Nonbinary")),
    education = factor(education, levels = c("<HS", "HS", "A", "B", "M", "P", "D", "NA")),
    socioeconomic = factor(socioeconomic, levels = c("<10k", "10-25k", "25-50k", "50-75k", "75-100k", "100-150k", ">150k", "NA")),
    english = factor(english, levels = c("Y", "N", "NA")),
    
    age.z = (age - mean(age, na.rm = T)) / (2 * sd(age, na.rm = T)),
    past_donations.z = (past_donations - mean(past_donations, na.rm = T)) / (2 * sd(past_donations, na.rm = T))
  ) %>%
  drop_na()
```

```{r}
base.formula = formula(donation ~ self_cancer + ff_cancer + gender + education + socioeconomic + past_donations.z + age.z)
```

# Exploration

Participants per cell

```{r}
t = table(trials[, c("cond_metaphor", "cond_sex")])
t = cbind(t, rowSums(t))
colnames(t)[3] = "Total"
t = rbind(t, colSums(t))
rownames(t)[4] = "Total"
t
```

## Experiment Duration

```{r}
summary(trials$rt_trial) / (1000)
summary(trials$total_time) / (1000*60)
ggplot(trials) + tm +
  geom_density(aes(total_time/(1000*60))) +
  labs(x = "Total Duration (mins)", y = "Density", title = "Total Duration Distribution")
```

First, 5th, 50th, and 95th quantiles for the actual trial response time. Then the mean trial response time. Then 5th, 50th, and 95th quantiles for experiment total duration. Lastly, mean total experiment duration.

```{r}
quantile(trials$rt_trial, c(0.05, 0.5, 0.95)) / (1000)
mean(trials$rt_trial) / (1000)
quantile(trials$total_time, c(0.05, 0.5, 0.95)) / (1000 * 60)
mean(trials$total_time) / (1000 * 60)
```

Take a look at the fastest and slowest participants to see if they are completely unreasonable outliers

```{r}
trials %>% arrange(rt_trial) %>% head()
```

```{r}
trials %>% arrange(desc(rt_trial)) %>% head()
```

## Prominent Donation Behaviors

First, portion of each gender and conditions that gave \$0. Then, summary stats of the donations. Then, proportion of participants who donate \$0, \$25, and \$50. These are natural breaks (minimum, default/middle, maximum) that might signal certain behavior (e.g. people often giving nothing, staying with the default value).

```{r}
trials %>%
  group_by(gender) %>%
  summarise(propZero = mean(donation == 0), sumZero = sum(donation == 0))

trials %>%
  group_by(cond_sex) %>%
  summarise(propZero = mean(donation == 0), sumZero = sum(donation == 0))

trials %>%
  group_by(cond_metaphor) %>%
  summarise(propZero = mean(donation == 0), sumZero = sum(donation == 0))
```

```{r}
summary(trials$donation)
mean(trials$donation == 0)
mean(trials$donation == 25)
mean(trials$donation == 50)
```

How do participants in each of the conditions behave?

First, simple histograms of donation amounts, both overall and broken up by condition.

```{r}
ggplot(trials) + tm +
  geom_histogram(aes(donation), binwidth = 2.5) +
  labs(x = "Donation Amount", y = "Count", title = "Donation Distribution") +
  lims(x=c(0, 50))

ggplot(trials) + tm +
  geom_histogram(aes(donation), binwidth = 2.5, position = "identity") +
  labs(x = "Donation Amount", y = "Count", title = "Donation Distributions by Condition") +
  facet_grid(vars(cond_sex), vars(cond_metaphor)) +
  lims(x=c(0, 50))
```

## Donations by Predictors

### Sympathy and Urgency

```{r}
summary(trials$sympathy, digits = 2)
summary(trials$urgent, digits = 2)
```

Quick peek at the differences in donation amounts given how much participants agreed with the followup questions.

```{r}
data %>%
  gather(question, value, urgent:sympathy) %>%
  ggplot(aes(as.factor(value), donation)) +
  geom_boxplot() +
  facet_grid(rows = vars(question))
```

Distribution of the followup questions

```{r}
ggplot(trials) + tm +
  geom_bar(aes(urgent, group=1, y=..prop..)) +
  scale_x_discrete(limits = seq(0,6)) +
  labs(x = "Urgent", y = "Proportion", title = "Urgent Distribution", subtitle = "\"Her situation is urgent.\"")

ggplot(trials) + tm +
  geom_bar(aes(sympathy, group=1, y=..prop..)) +
  scale_x_discrete(limits = seq(0,6)) +
  labs(x = "Sympathy", y = "Proportion", title = "Sympathy Distribution", subtitle = "\"Her situation is one I sympathize with.\"")
```

```{r}
lbs = c("male" = "Condition: Male",
        "female" = "Condition: Female")

ggplot(trials) + tm +
  geom_bar(aes(urgent, fill = cond_metaphor), width = 0.9, position = position_dodge(preserve = "single")) +
  lims(x = c(0, 6)) +
  labs(x = "Urgent", y = "Count", title = "Urgent Distribution", subtitle = "\"Her situation is urgent.\"")
  # facet_grid(~cond_sex, labeller = as_labeller(lbs)) # remove this line to graph only the metaphor condition

ggplot(trials) + tm +
  geom_bar(aes(sympathy, fill = cond_metaphor), width = 0.9, position = position_dodge(preserve = "single")) +
  lims(x = c(0, 6)) +
  labs(x = "Sympathy", y = "Count", title = "Sympathy Distribution", subtitle = "\"Her situation is sympathy\"")
  # facet_grid(~cond_sex, labeller = as_labeller(lbs))  # remove this line to graph only the metaphor condition
```

Does the metaphorical condition have a relationship to participant's rating of perceived sympathy?

```{r}
sympathy.model = lm(sympathy ~ gender + education + socioeconomic + past_donations.z + age.z + self_cancer + ff_cancer, data = trials)
sympathy.model.full = lm(sympathy ~ cond_metaphor*cond_sex + gender + education + socioeconomic + past_donations.z + age.z + self_cancer + ff_cancer, data = trials)

summary(sympathy.model.full)
anova(sympathy.model, sympathy.model.full, test = "Chisq")
```

Does the metaphorical condition have a relationship to participant's rating of perceived urgency?

```{r}
urgent.model = lm(urgent ~ gender + education + socioeconomic + past_donations.z + age.z + self_cancer + ff_cancer, data = trials)
urgent.model.full = lm(urgent ~ cond_metaphor*cond_sex + gender + education + socioeconomic + past_donations.z + age.z + self_cancer + ff_cancer, data = trials)

summary(urgent.model.full)
anova(urgent.model, urgent.model.full, test = "Chisq")
```

### Demographics

Explore the distributions of demographic variables.

```{r}
ggplot(trials) + tm +
  geom_density(aes(donation, color=self_cancer)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Self Cancer", title = "Donation Distributions by Education Level")

ggplot(trials) + tm +
  geom_density(aes(donation, color=ff_cancer)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Friends and Family\nCancer", title = "Donation Distributions by Friends and Family Cancer")

ggplot(trials) + tm +
  geom_density(aes(donation, color=gender)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Gender", title = "Donation Distributions by Gender")

ggplot(trials) + tm +
  geom_density(aes(donation, color=education)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Education Level", title = "Donation Distributions by Education Level")

ggplot(trials) + tm +
  geom_density(aes(donation, color=socioeconomic)) +
  lims(x = c(0, 50)) +
  labs(x = "Donation Amount", y = "Density", color = "Socioeconomic Level", title = "Donation Distributions by Socioeconomic Level")

ggplot(trials, aes(age, donation)) + tm +
  geom_point() +
  geom_smooth(method = "lm")+
  lims(y = c(0, 50)) +
  labs(x = "Age", y = "Donation Amount", title = "Donation distribution by Age")

ggplot(trials, aes(past_donations, donation)) + tm +
  geom_point() +
  geom_smooth(method = "lm") +
  lims(y = c(0, 50)) +
  labs(x = "Past Donations", y = "Donation Amount", title = "Donation distribution by Past Donations")

ggplot(trials, aes(self_cancer, donation)) + tm +
  geom_boxplot(alpha = 0.5) +
  geom_jitter(width = 0.1) +
  lims(y = c(0, 50)) +
  labs(title = "Donation distributions by Overall Cancer Experience")
```

#### Gender effects

Is there a relationship between participant gender, stimulus sex, and donation?

```{r}
model.base = lm(update(base.formula, . ~ . + cond_sex), data = trials)
model.full = lm(update(base.formula, . ~ . + cond_sex*gender), data = trials)

summ(model.full, confint = T, digits = 3)
anova(model.base, model.full, test = "Chisq")
```

3-way interaction going on between `ppt gender`, `metaphor`, and `patient gender`. 

```{r}
ggplot(trials, aes(cond_metaphor, donation, color = gender)) + tm +
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    position = position_dodge(width = 0.35), 
    width = 0.2) +
  labs(x = "Metaphor condition",
       y = "Donation",
       title = "Donation by metaphor, patient gender, and ppt gender") +
  facet_grid(~cond_sex)

summ(
  lm(data = trials, update(base.formula, . ~ . + cond_metaphor*cond_sex*gender)),
  confint = F,
  digits = 3
  )
```

Effect of gender **congruence**?

```{r}
trials = mutate(trials, gender_congruent = (gender == "Male" & cond_sex == "male") | (gender == "Female" & cond_sex == "female"))

ggplot(trials, aes(cond_metaphor, donation, color = gender_congruent)) + tm +
  stat_summary(
    fun.data = mean_se, 
    geom = "errorbar", 
    position = position_dodge(width = 0.35), 
    width = 0.2) +
  labs(x = "Metaphor condition",
       y = "Donation",
       title = "Donation by metaphor and gender congruence")

summ(
  lm(data = trials, update(base.formula, . ~ . + cond_metaphor*gender_congruent)),
  confint = F,
  digits = 3
  )
```

### Experience effect

Is there a relationship between participant's experience with cancer and donation?

```{r}
model.base = lm(update(base.formula, . ~ .  - self_cancer), data = trials)
model.full = lm(base.formula, data = trials)

summ(model.full, confint = T, digits = 3)
anova(model.base, model.full, test = "Chisq")

model.base = lm(update(base.formula, . ~ .  - ff_cancer), data = trials)
model.full = lm(base.formula, data = trials)

summ(model.full, confint = T, digits = 3)
anova(model.base, model.full, test = "Chisq")
```

## Coding Patient Description Responses

TODO: Responses will be coded for the presence of metaphor, either mentioning Only Journey, Only Battle, Mixed Metaphors, or No Metaphors.

## Metaphor in Passage on Metaphor in Description

We analyzed the free-response answers the participants completed in response to being asked to explain the patient's situation to a friend. We were interested in whether the metaphor in the passage predicts the presence of metaphors in the description. We will model this with a logistic regression, accounting for the covariates included in the primary hypothesis model.

```{r}
model.base = glm(I(description_metaphor != "none") ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z, data = trials, family = "binomial")
model.full = glm(I(description_metaphor != "none") ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z + cond_metaphor, data = trials, family = "binomial")

summ(model.full, confint = T, digits = 3)
anova(model.base, model.full, test = "Chisq")
```

```{r}
model.base = glm(I(description_metaphor == "journey") ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z, data = trials, family = "binomial")
model.full = glm(I(description_metaphor == "journey") ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z + cond_metaphor, data = trials, family = "binomial")

summ(model.full, confint = T, digits = 3)
anova(model.base, model.full, test = "Chisq")
```

```{r}
model.base = glm(I(description_metaphor == "battle") ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z, data = trials, family = "binomial")
model.full = glm(I(description_metaphor == "battle") ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z + cond_metaphor, data = trials, family = "binomial")

summ(model.full, confint = T, digits = 3)
anova(model.base, model.full, test = "Chisq")
```

## Preserved Metaphor on Donation

Additionally, we are interested in knowing whether preserved metaphor usage in responses predicts a main effect of donation amount. We will model this with an ordinary linear regression model, accounting for the same covariates as the other models.

```{r}
model.base = lm(donation ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z, data = trials)
model.full = lm(donation ~ self_cancer + ff_cancer + gender + education + socioeconomic + age.z + I(description_metaphor != "none"), data = trials)

summ(model.full, confint = T, digits = 3)
anova(model.base, model.full, test = "Chisq")
```

## Mediation of Urgency and Sympathy

Additionally, we will use the responses to the questions about perceived urgency and sympathy toward the patient as variables in a mediation analysis to explore their role in mediating metaphor's effect on donation amounts.

# Sample Random ppt

```{r}
length(unique(trials$ppt))
```

```{r}
id = sample(trials$ppt, 1)

trials[trials$ppt == id, ]
```

