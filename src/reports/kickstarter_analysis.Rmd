---
title: "Metaphor Analysis in Kickstarter Campaigns"
output:
  pdf_document:
    toc: yes
  html_document:
    toc: yes
---

**Sean Trott and Alex Liebscher**

# Introduction

**Questions to ask**: 

Characterizing:
1. What's the distribution of metaphors overall? Does it differ by campaign category?
2. What about metaphor productivity? Within a metaphor family, are there canonical instantiations of a metaphor? (E.g. "fight battle"). Or even if productivity is low generally, are instantiations varied?
3. How do metaphors relate to the *length* of campaigns?

Predicting campaigns:
1. How does having a metaphor influence campaign success/failure, #backers, and mean donation?
2. How does having a *specific metaphor* (battles vs. journeys) influence campaign success/failure, #backers, mean donation?

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Metaphor Analysis

We have several dependent variables which we would like to model as accurately as possible to determine the variables which contribute most to their outcomes. In particular, we care about the effect of the dominance (or lack thereof) of metaphor in each project. We first explore the data a little, and then begin a series of model comparisons for the dependent variables. Comparing models gives transparency to the contributions of each variable toward the target.

## Load Data

```{r cars}
dat <- read.csv('../../data/processed/kickstarter_projects.csv')
head(dat)
```

```{r}
nrow(dat)
colnames(dat)
```

```{r}
library(lme4)
library(tidyverse)
# library(Hmisc)
```

```{r}
ggplot(dat) + geom_bar(aes(x=year), stat="count") + ggtitle("Number of projects per year")
```

Very few projects are in 2009, and so for simplicity's sake and to simplify the model just a tad, we remove 2009.
```{r}
dat <- dat[dat$year >= 2010, ]
```

```{r}
ggplot(dat) + geom_bar(aes(x=from_US), stat="count") + ggtitle("Proportion of projects per country")
```

Most projects are US based. Reduce model complexity by restricting to US then.

```{r}
dat <- dat[dat$from_US == 1, ]
```

```{r}
nrow(dat[dat$from_Town == 0, ])
nrow(dat[dat$from_Town != 0, ])
```

There are only 10 projects not from Towns, so we'll just remove them for simplicity's sake.

```{r}
dat <- dat[dat$from_Town == 1, ]
```

There is a reasonable amount of projects in each of the aggregated categories (see the data processing python script for more information on the aggregation).

```{r}
ggplot(dat) + geom_bar(aes(x=category), stat="count") +
  theme(axis.text.x=element_text(angle = 60, hjust=1))
```

Very few projects are equally dominated by both battle and journey metaphors.

```{r}
ggplot(dat) + geom_bar(aes(x=dominant), stat="count") + ggtitle("Dominant metaphor type count")
```


Is it enough to just have it or does the amount matter

Why not have both salience and dominant (they might both be sig)

```{r}
short <- 30 - 3.5
long <- 30 + 3.5
very_long <- 30 + 14

dat$duration_cat = ""
dat[dat$duration_float < short, ]$duration_cat = "short"
dat[dat$duration_float > short & dat$duration_float <= long, ]$duration_cat = "exp"
dat[dat$duration_float > long & dat$duration_float <= very_long, ]$duration_cat = "long"
dat[dat$duration_float > very_long, ]$duration_cat = "vlong"
```

We scale/z-score the continuous variables according to how we wish to interpret the coefficients of the model. From Andrew Gelman: "Standardizing puts things on an approximately common scale .... (Standarize for) comparing coefficients for different predictors within a model". Binary and categorical variables are left as is.

Looking to further justify these decisions a little more rigorously...

```{r}
dat$goal_sc <- scale(dat$goal)
dat$text_length_words_sc <- scale(dat$text_length_words)
dat$month <- factor(dat$month)

dat$any_metaphor = 1 - dat$dominant_neither
```


Seem like comprehensive sources:
https://bbolker.github.io/mixedmodels-misc/glmmFAQ.html#model-definition
https://ase.tufts.edu/gsc/gradresources/guidetomixedmodelsinr/mixed%20model%20guide.html

# Primary analyses

We are interested in the effect that metaphor dominance has on the funding status of a project.

Each sample is independent (what is in one project has no affect on whats in another sample).

**DV**: status, pledged_to_goal, mean_donation, backers
**IV**: Goal amount, staff_pick, category, geo_state, text_length_words, duration_float, month, year, dominant_*

Various sources were used to determine what should be a random effect and what should be fixed, and how to model interactions and correlations between variables, including:

 - Data Analysis Using Regression and Multilevel/Hierarchical Models (Gelman and Hill, 2006)
 - Interactions in Generalized Linear Models: Theoretical Issues and an Application to Personal Vote-Earning Attributes (Tsai and Gill, 2013)
 - Should I Use Fixed or Random Effects? (Clark and Linzer, 2012)
 - Random effects structure for confirmatory hypothesis testing: Keep it maximal (Barr et al., 2013)
 - https://stats.stackexchange.com/questions/13166/rs-lmer-cheat-sheet
 - https://stats.stackexchange.com/questions/4700/what-is-the-difference-between-fixed-effect-random-effect-and-mixed-effect-mode/151800#151800
 - https://rlbarter.github.io/Practical-Statistics/2017/03/03/fixed-mixed-and-random-effects/
 - https://stats.stackexchange.com/questions/323273/what-to-do-with-random-effects-correlation-that-equals-1-or-1
 - Fitting linear mixed-effects models using lme4 (Bates et al., 2014)

# Status

```{r}
mod.none.corr <- glmer(status ~ (1|year) + (1|month) + (1|geo_state), data = dat, family = "binomial")
as.data.frame(VarCorr(mod.none.corr))
```

Nesting and Chi2 differences:
https://www.psychologie.uzh.ch/dam/jcr:ffffffff-b371-2797-0000-00000fda8f29/chisquare_diff_en.pdf

```{r}
# no fixed effects, only random
mod.none <- glmer(status ~ (1|geo_state) + (1|month) + (1|year), 
                  data = dat, family = "binomial", nAGQ = 0)

# add staff pick
mod.staff <- glmer(status ~ staff_pick + (1|geo_state) + (1|month) + (1|year), 
                   data = dat, family = "binomial", nAGQ = 0)

# add duration category
mod.staff.dur <- glmer(status ~ duration_cat + staff_pick + (1|geo_state) + (1|month) +
                         (1|year), 
                       data = dat, family = "binomial", nAGQ = 0)

# add length of text (in words)
mod.staff.dur.length <- glmer(status ~ text_length_words_sc + duration_cat + staff_pick +
                                (1|geo_state) + (1|month) + (1|year), 
                              data = dat, family = "binomial", nAGQ = 0)

# add scaled goal amount
mod.staff.dur.length.goal <- glmer(status ~ goal_sc + text_length_words_sc + duration_cat +
                                     staff_pick + (1|geo_state) + (1|month) + (1|year), 
                                   data = dat, family = "binomial", nAGQ = 0)

# add category
mod.staff.dur.length.goal.cat <- glmer(status ~ category + goal_sc + text_length_words_sc + 
                                     duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                                   data = dat, family = "binomial", nAGQ = 0)

# add first instantiation
mod.staff.dur.length.goal.cat.inst <- glmer(status ~ category + goal_sc + text_length_words_sc + 
                                           duration_cat + staff_pick + first_instantiation + (1|geo_state) + (1|month) + (1|year), 
                                         data = dat, family = "binomial", nAGQ = 0)

anova(mod.none, mod.staff, test='Chisq')
anova(mod.staff, mod.staff.dur, test='Chisq')
anova(mod.staff.dur, mod.staff.dur.length, test='Chisq')
anova(mod.staff.dur.length, mod.staff.dur.length.goal, test='Chisq')
anova(mod.staff.dur.length, mod.staff.dur.length.goal.cat, test='Chisq')
anova(mod.staff.dur.length.goal.cat, mod.staff.dur.length.goal.cat.inst, test='Chisq')
```

The final base model before adding metaphor variables:

```{r}
summary(mod.staff.dur.length.goal.cat)
```


```{r}
dat %>%
  ggplot(aes(x =  fct_recode(factor(status), "Successful"="1", "Failed"="0"),
             y = text_length_words_sc)) +
  geom_boxplot() +
  labs(x = "Status",
       y = "Number of words in campaign") +
  theme_minimal()
```


## Add metaphors

Use `nAQG=0` because `nAQG=1` cannot converge in a reasonable number (10,000) of iterations

See https://stats.stackexchange.com/questions/77313/why-cant-i-match-glmer-family-binomial-output-with-manual-implementation-of-g and https://www.rdocumentation.org/packages/lme4/versions/1.1-19/topics/glmer

We exclude the both metaphors as dominant variable since there are so few in this category that there is an overwhelmingly significant difference.

```{r}
mod.dom.battle <- glmer(status ~ dominant_battle + category + goal_sc + text_length_words_sc +
                          duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                        data = dat, 
                        family = "binomial", 
                        nAGQ = 0)

mod.dom.battle.prod <- glmer(status ~ battle_prod + dominant_battle + category + goal_sc + text_length_words_sc +
                          duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                        data = dat, 
                        family = "binomial", 
                        nAGQ = 0)

mod.dom.journey <- glmer(status ~ dominant_journey + category + goal_sc + text_length_words_sc +
                           duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year),
                         data = dat,
                         family = "binomial",
                         nAGQ = 0)

mod.dom.journey.prod <- glmer(status ~ journey_prod + dominant_journey + category + goal_sc + text_length_words_sc +
                           duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year),
                         data = dat,
                         family = "binomial",
                         nAGQ = 0)

# mod.dom.neither <- glmer(status ~ dominant_neither + category + goal_sc + text_length_words_sc +
#                            duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year),
#                          data = dat, family = "binomial", nAGQ = 0)
# 
# mod.dom.all <- glmer(status ~ dominant + category + goal_sc + text_length_words_sc + duration_cat +
#                        staff_pick + (1|geo_state) + (1|month) + (1|year), 
#                      data = dat, 
#                      family = "binomial", 
#                      nAGQ = 0)
# 
# mod.dom.any <- glmer(status ~ any_metaphor + category + goal_sc + text_length_words_sc + duration_cat +
#                        staff_pick + (1|geo_state) + (1|month) + (1|year), 
#                      data = dat, 
#                      family = "binomial", 
#                      nAGQ = 0)

anova(mod.staff.dur.length.goal.cat, mod.dom.battle)
anova(mod.dom.battle, mod.dom.battle.prod)
anova(mod.staff.dur.length.goal.cat, mod.dom.journey)
anova(mod.dom.journey, mod.dom.journey.prod)
# anova(mod.staff.dur.length.goal.cat, mod.dom.neither)
# anova(mod.staff.dur.length.goal.cat, mod.dom.all)
# anova(mod.staff.dur.length.goal.cat, mod.dom.any)

```

```{r}
dat %>%
  ggplot(aes(fill = fct_recode(factor(status), "Successful"="1", "Failed"="0"),
             x = dominant)) +
  geom_bar(stat = "count", position = "dodge") +
  labs(x = "Status") +
  guides(fill=guide_legend(title="Status")) +
  theme_minimal()
```


# Number of Backers

```{r}
nrow(dat[dat$backers > 600, ])
hist(dat$backers[dat$backers < 600])
```

We limit to 600 because removing the outliers leaves us with a nicely poisson shaped distribution.

```{r}
dat.pois <- dat[dat$backers < 600, ]
```


```{r}
mod.none.corr <- glmer(backers ~ (1|month) + (1|year) + (1|geo_state), data = dat.pois, family = "poisson")
as.data.frame(VarCorr(mod.none.corr))
```

These poisson models are very complex due to the potential outcomes, this seems to result in significance for every change. Need to figure out how to deal with this.


```{r}
# no fixed effects, only random
mod.none <- glmer(backers ~ (1|geo_state) + (1|month) + (1|year), 
                  data = dat.pois, family = "poisson", nAGQ = 1)
# add staff pick
mod.staff <- glmer(backers ~ staff_pick + (1|geo_state) + (1|month) + (1|year), 
                   data = dat.pois, family = "poisson", nAGQ = 1)
# add duration of campaign (in days)
mod.staff.dur <- glmer(backers ~ duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                       data = dat.pois, family = "poisson", nAGQ = 1)
# add length of text (in words)
mod.staff.dur.length <- glmer(backers ~ text_length_words_sc + duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                              data = dat.pois, family = "poisson", nAGQ = 1)
# add scaled goal amount
mod.staff.dur.length.goal <- glmer(backers ~ goal_sc + text_length_words_sc + duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                                   data = dat.pois, family = "poisson", nAGQ = 1)

# add category
mod.staff.dur.length.goal.cat <- glmer(backers ~ category + goal_sc + text_length_words_sc + duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                                   data = dat.pois, family = "poisson", nAGQ = 1)

anova(mod.none, mod.staff, test='Chisq')
anova(mod.staff, mod.staff.dur, test='Chisq')
anova(mod.staff.dur, mod.staff.dur.length, test='Chisq')
anova(mod.staff.dur.length, mod.staff.dur.length.goal, test='Chisq')
anova(mod.staff.dur.length.goal, mod.staff.dur.length.goal.cat, test='Chisq')
```

```{r}
summary(mod.staff.dur.length.goal.cat)
```

```{r}
dat.pois %>%
  ggplot(aes(x = text_length_words_sc,
             y = backers)) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Number of words in campaign text",
       y = "Number of backers") +
  theme_minimal()

dat.pois %>%
  ggplot(aes(x = staff_pick,
             y = backers)) +
  geom_boxplot() +
  labs(x = "Staff pick",
       y = "Number of backers") +
  theme_minimal()
```

## Add metaphors

```{r}
mod.dom.battle <- glmer(backers ~ dominant_battle + category + goal_sc + text_length_words_sc + 
                          duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                        data = dat.pois, family = "poisson", nAGQ = 1)

mod.dom.journey <- glmer(backers ~ dominant_journey + category + goal_sc + text_length_words_sc + 
                           duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                         control=glmerControl(optimizer="bobyqa"),
                         data = dat.pois, family = "poisson", nAGQ = 1)

mod.dom.neither <- glmer(backers ~ dominant_neither + category + goal_sc + text_length_words_sc + 
                           duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                         data = dat.pois, family = "poisson", nAGQ = 1)

mod.dom.all <- glmer(backers ~ dominant + category + goal_sc + text_length_words_sc + 
                       duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                     data = dat.pois, family = "poisson", nAGQ = 1)

mod.dom.any <- glmer(backers ~ any_metaphor + category + goal_sc + text_length_words_sc + 
                       duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                     data = dat.pois, family = "poisson", nAGQ = 1)

anova(mod.staff.dur.length.goal.cat, mod.dom.battle)
anova(mod.staff.dur.length.goal.cat, mod.dom.journey)
anova(mod.staff.dur.length.goal.cat, mod.dom.neither)
anova(mod.staff.dur.length.goal.cat, mod.dom.all)
anova(mod.staff.dur.length.goal.cat, mod.dom.any)
```

divergence metric, various different ways to operationalize, measure against known metaphor keywords

haphexlagomaden

a type: distribution of keywords in corpus, instances of 

how many different ways are you using this give metaphor vs how unique is this given passage

```{r}
dat.pois %>%
  ggplot(aes(x = dominant,
             y = backers)) +
  geom_boxplot() +
  theme_minimal()
```

# Mean Donation

```{r}
library(car)
```

Quickly playing around with the distribution of mean_donation.

mean_donation isn't really gaussian, but for simplicity's sake, we'll use that for now. Pick a better dist later. Unsurprisingly, there aren't any significant effects when adding in dominant metaphors.

```{r}
# no fixed effects, only random
mod.none <- lmer(log(mean_donation+1) ~ (1|geo_state) + (1|month) + (1|year), 
                  data = dat)
# add staff pick
mod.staff <- lmer(log(mean_donation+1) ~ staff_pick + (1|geo_state) + (1|month) + (1|year), 
                   data = dat)

# add duration of campaign (in days)
mod.staff.dur <- lmer(log(mean_donation+1) ~ duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                       data = dat)

# add length of text (in words)
mod.staff.dur.length <- lmer(log(mean_donation+1) ~ text_length_words_sc + duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                              data = dat)

# add scaled goal amount
mod.staff.dur.length.goal <- lmer(log(mean_donation+1) ~ goal_sc + text_length_words_sc + duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                                   data = dat)

# add category
mod.staff.dur.length.goal.cat <- lmer(log(mean_donation+1) ~ category + goal_sc + text_length_words_sc + duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                                   data = dat)

anova(mod.none, mod.staff, test='Chisq')
anova(mod.staff, mod.staff.dur, test='Chisq')
anova(mod.staff.dur, mod.staff.dur.length, test='Chisq')
anova(mod.staff.dur.length, mod.staff.dur.length.goal, test='Chisq')
anova(mod.staff.dur.length.goal, mod.staff.dur.length.goal.cat, test='Chisq')
```

```{r}
summary(mod.staff.dur.length.goal.cat)
```

```{r}
mod.dom.battle <- lmer(log(mean_donation+1) ~ dominant_battle + category + goal_sc + text_length_words_sc + 
                          duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                        data = dat)

mod.dom.journey <- lmer(log(mean_donation+1) ~ dominant_journey + category + goal_sc + text_length_words_sc + 
                           duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year),
                         data = dat)

mod.dom.neither <- lmer(log(mean_donation+1) ~ dominant_neither + category + goal_sc + text_length_words_sc + 
                           duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                         data = dat)

mod.dom.all <- lmer(log(mean_donation+1) ~ dominant + category + goal_sc + text_length_words_sc + 
                       duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                     data = dat)

mod.dom.any <- lmer(log(mean_donation+1) ~ any_metaphor + category + goal_sc + text_length_words_sc + 
                       duration_cat + staff_pick + (1|geo_state) + (1|month) + (1|year), 
                     data = dat)

anova(mod.staff.dur.length.goal.cat, mod.dom.battle)
anova(mod.staff.dur.length.goal.cat, mod.dom.journey)
anova(mod.staff.dur.length.goal.cat, mod.dom.neither)
anova(mod.staff.dur.length.goal.cat, mod.dom.all)
anova(mod.staff.dur.length.goal.cat, mod.dom.any)
```

```{r}
mod <- lm(status ~ staff_pick, data = dat)
summary(mod)
```



```{r}
dat.pois %>%
  ggplot(aes(x = dominant,
             y = log(mean_donation+1))) +
  geom_boxplot() +
  theme_minimal()
```